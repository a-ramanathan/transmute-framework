<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/EventStore/EventStore.spec.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/transmute-industries/transmute-framework" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRandomAddress">getRandomAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TF">TF</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-firebaseConfig">firebaseConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-envs">envs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-web3">web3</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">EventStore</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readEvent">readEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readEvents">readEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-writeEvent">writeEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-writeEvents">writeEvents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-projectReducer">projectReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EventStore">EventStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-event">event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-eventStream">eventStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-expectedProjectState">expectedProjectState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-initialProjectState">initialProjectState</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">EventStore/EventTypes</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EvenTypes">EvenTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NEW_EVENT">NEW_EVENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EVENT_SCHEMAS">EVENT_SCHEMAS</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">EventStore/Persistence</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getItem">getItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setItem">setItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EVENT_SCHEMAS">EVENT_SCHEMAS</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">EventStore/ReadModel</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-maybeSyncReadModel">maybeSyncReadModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readModelGenerator">readModelGenerator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ReadModel">ReadModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">EventStore/Transactions</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eventFromLog">eventFromLog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eventsFromTransaction">eventsFromTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPropFromSchema">getPropFromSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOG">LOG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TX">TX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Transactions">Transactions</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/EventStore/EventStore.spec.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

import { web3 } from &apos;../env&apos;
import { assert } from &apos;chai&apos;

import {
  EventStore
} from &apos;./EventStore&apos;

import {Persistence } from &apos;./Persistence&apos;

import { ReadModel } from &apos;./ReadModel&apos;

import {
  event,
  eventStream,
  initialProjectState,
  expectedProjectState,
  projectReducer
} from &apos;./EventStore.mock&apos;

let es, startEventCount, maybeUpdatedReadModel

describe(&apos;EventStore&apos;, () =&gt; {

  before(async () =&gt; {
    // console.log(TF)
    es = await EventStore.ES.deployed()
    startEventCount = (await es.eventCount()).toNumber()

  })

  describe(&apos;.writeEvent&apos;, () =&gt; {
    it(&apos;should return the event at the index&apos;, async () =&gt; {
      let events = await EventStore.writeEvent(es, event, web3.eth.accounts[0])
      assert.equal(events.length, 1)
      assert.equal(events[0].Type, event.Type)
      assert.equal(events[0].AddressValue, event.AddressValue)
      assert.equal(events[0].UIntValue, event.UIntValue)
      assert.equal(events[0].StringValue, event.StringValue)
    })
  })

  describe(&apos;.readEvent&apos;, () =&gt; {
    it(&apos;should return the event at the index&apos;, async () =&gt; {
      let event = await EventStore.readEvent(es, 0)
      assert.equal(event.Type, event.Type)
      assert.equal(event.AddressValue, event.AddressValue)
      assert.equal(event.UIntValue, event.UIntValue)
      assert.equal(event.StringValue, event.StringValue)
    })
  })

  describe(&apos;.writeEvents&apos;, () =&gt; {
    it(&apos;should return the events written to the event store&apos;, async () =&gt; {
      let events = await EventStore.writeEvents(es, eventStream, web3.eth.accounts[0])
      assert.equal(events.length, 3)
      // console.log(events)
    })
  })

  describe(&apos;.readEvents&apos;, () =&gt; {
    it(&apos;should return the events in the contract starting with the index&apos;, async () =&gt; {
      let events = await EventStore.readEvents(es, startEventCount)
      assert.equal(events.length, 4)
      // console.log(events)
    })
  })

  describe(&apos;.setItem&apos;, () =&gt; {
    it(&apos;should return the value when passed a valid key, after saving the value&apos;, async () =&gt; {
      Persistence.setItem(initialProjectState.Id, initialProjectState)
        .then((readModel) =&gt; {
          assert.equal(initialProjectState.Id, readModel.Id)
          assert.equal(initialProjectState.Name, readModel.Name)
        })
    })
  })

  describe(&apos;.getItem&apos;, () =&gt; {
    it(&apos;should return null for invalid key&apos;, async () =&gt; {
      Persistence.getItem(&apos;not-a-real-key&apos;)
        .then((readModel) =&gt; {
          assert.isNull(readModel)
        })
    })

    it(&apos;should return a readModel when passed valid readModelKey&apos;, async () =&gt; {
      Persistence.getItem(initialProjectState.Id)
        .then((readModel) =&gt; {
          assert.equal(initialProjectState.Id, readModel.Id)
          assert.equal(initialProjectState.Name, readModel.Name)
        })
    })
  })

  describe(&apos;.readModelGenerator&apos;, () =&gt; {
    it(&apos;should return the the initial reducer state when no events exist&apos;, async () =&gt; {
      let projectModel = ReadModel.readModelGenerator(initialProjectState, projectReducer, [])
      assert.equal(projectModel.Id, initialProjectState.Id)
      assert.equal(projectModel.EventCount, initialProjectState.EventCount)
      assert.equal(projectModel.Users, initialProjectState.Users)
      assert.equal(projectModel.Milestones, initialProjectState.Milestones)
    })

    it(&apos;should return the updated read model when passed events&apos;, async () =&gt; {
      let projectHistory = await EventStore.readEvents(es, startEventCount)
      let projectModel = ReadModel.readModelGenerator(initialProjectState, projectReducer, projectHistory)
      assert.equal(projectModel.Id, expectedProjectState.Id)
      assert.equal(projectModel.Name, expectedProjectState.Name)
      assert.isArray(projectModel.Users, expectedProjectState.Users)
      assert.isArray(projectModel.Milestones, expectedProjectState.Milestones)
    })
  })

  describe(&apos;maybeSyncReadModel&apos;, () =&gt; {
    it(&apos;should retrieve a read model and sync any missing events from the contract&apos;, async () =&gt; {
      let _maybeUpdatedReadModel = await ReadModel.maybeSyncReadModel(es, initialProjectState, projectReducer)
      maybeUpdatedReadModel = _maybeUpdatedReadModel
    })

    it(&apos;should return quickly if no new events exist&apos;, async () =&gt; {
      let sameReadModel = await ReadModel.maybeSyncReadModel(es, maybeUpdatedReadModel, projectReducer)
      assert.equal(sameReadModel.Name, maybeUpdatedReadModel.Name)
      assert.equal(sameReadModel.EventCount, maybeUpdatedReadModel.EventCount)
    })
  })

})


</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
